# V29 Negative Inventory Clamping

**Date:** 2025-12-06
**Terminal:** Claude 1

## Summary

Added a non-destructive "view" in V29's `getResult()` that identifies and excludes positions with negative net inventory from UI parity calculations.

## Problem Statement

Terminal 3's research identified that some wallets have positions where `totalQuantity < 0`. These arise from:
- Selling tokens obtained via ERC1155 transfers (not tracked by CLOB)
- Position splits (lock USDC â†’ receive YES + NO tokens)
- Other off-ledger token sources

Per Polymarket subgraph semantics, the inventory guard clamps sells to tracked inventory:
```javascript
const adjustedAmount = amount.gt(userPosition.amount)
  ? userPosition.amount  // CLAMP
  : amount;
```

Positions that go negative are artifacts of incomplete data and should not contribute to PnL.

## Implementation

### New Fields in V29Result

```typescript
uiParityClampedPnl: number;           // uiParityPnl - negativeInventoryPnlAdjustment
negativeInventoryPositions: number;   // Count of positions with qty < -1e-6
negativeInventoryPnlAdjustment: number; // PnL excluded from clamped total
```

### Logic in getResult()

```typescript
const isNegativeInventory = position.totalQuantity < -1e-6;

if (isNegativeInventory) {
  negativeInventoryPositions++;
  negativeInventoryPnlAdjustment += position.realizedPnl;
}

// Final calculation
const uiParityClampedPnl = uiParityPnl - negativeInventoryPnlAdjustment;
```

### Key Points

1. **Non-destructive**: This is a VIEW at result time, not a modification to the state machine
2. **Threshold**: Uses `-1e-6` to avoid floating point noise
3. **V29QuickResult updated**: Includes new fields for quick access
4. **Regression harness updated**: Compares `uiParityClampedPnl` alongside other metrics

## Regression Results (8-wallet targeted test)

```
OVERALL PASS RATES
                     | V23c      | V29 Guard | V29 UiParity | V29 Clamped | V29 NoGuard
---------------------|-----------|-----------|--------------|-------------|------------
Pass at <1%          |   7/8 (88%) |   4/8 (50%) |    6/8 (75%) |   6/8 (75%) |   4/8 (50%)
Pass at <5%          |   8/8 (100%) |   5/8 (63%) |    8/8 (100%) |   8/8 (100%) |   5/8 (63%)

NEGATIVE INVENTORY STATS
  Total Negative Inventory Positions: 0
  Total PnL Adjustment:               $0
```

**Observation:** In the top 20 wallets by absolute PnL, none had negative inventory positions. The V29 engine's inventory guard during event processing is already clamping effectively. The negative inventory check at result time serves as an additional safety net for edge cases that might slip through.

## Files Modified

1. `lib/pnl/inventoryEngineV29.ts`
   - Added `uiParityClampedPnl`, `negativeInventoryPositions`, `negativeInventoryPnlAdjustment` to `V29Result`
   - Updated `getResult()` to detect and track negative inventory positions
   - Updated `V29QuickResult` and `calculateV29Quick()` to expose new fields

2. `scripts/pnl/run-regression-matrix.ts`
   - Added `v29UiParityClamped` summary stats
   - Added `v29GuardUiParityClampedPnL`, `v29GuardNegativeInventoryPositions`, `v29GuardNegativeInventoryPnlAdjustment` to `WalletResult`
   - Updated console and markdown reports to display clamped metrics

## Future Considerations

If negative inventory positions are found to be significant in production:
1. Track which condition_ids are affected for debugging
2. Consider adding a `negativeInventoryConditions: string[]` field to V29Result
3. Investigate root causes (missing CLOB data, CTF backfill gaps, etc.)

---

*Report generated by Claude 1*

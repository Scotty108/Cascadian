# Terminal 2 Handoff: Enforcement Layer Complete

**Date:** 2025-12-09
**Terminal:** 2 (Scaling & Hardening)
**Status:** Implementation Complete

---

## Deliverables Created

| Deliverable | Path | Status |
|-------------|------|--------|
| Canonical Tables Export | `lib/pnl/canonicalTables.ts` | ✅ Created |
| Canonical Audit Script | `scripts/pnl/audit-canonical-usage.ts` | ✅ Created |
| Validation Matrix V1 | `docs/systems/pnl/VALIDATION_MATRIX_V1.md` | ✅ Created |
| Audit Report | `docs/reports/CANONICAL_TABLE_AUDIT_2025_12_09.md` | ✅ Generated |

---

## What Was Built

### 1. `lib/pnl/canonicalTables.ts`

Single source of truth for all table references. Exports:

```typescript
// Product surface selection
getLedgerForSurface('leaderboard_v1_clob') → pm_unified_ledger_v9_clob_tbl
getLedgerForSurface('full_pnl') → pm_unified_ledger_v8_tbl

// Canonical tables registry
CANONICAL_TABLES.TRADER_EVENTS    // pm_trader_events_v2
CANONICAL_TABLES.UNIFIED_LEDGER_FULL  // pm_unified_ledger_v8_tbl
CANONICAL_TABLES.UNIFIED_LEDGER_CLOB  // pm_unified_ledger_v9_clob_tbl
CANONICAL_TABLES.TOKEN_MAP        // pm_token_to_condition_map_v5
CANONICAL_TABLES.RESOLUTIONS      // pm_condition_resolutions

// Deprecated tables list (for audit flagging)
DEPRECATED_TABLES = ['pm_unified_ledger_v4', 'pm_unified_ledger_v5', ...]

// Validation helpers
isCanonicalTable(name) → boolean
isDeprecatedTable(name) → boolean
getCanonicalReplacement(deprecated) → string | null
```

### 2. `scripts/pnl/audit-canonical-usage.ts`

Scans `lib/pnl/` and `scripts/pnl/` for:
- Hardcoded deprecated table names
- Hardcoded canonical tables (should use imports)

**Output:**
- Console report with violations grouped by file
- Markdown report auto-generated at `docs/reports/CANONICAL_TABLE_AUDIT_2025_12_09.md`

**Usage:**
```bash
npx tsx scripts/pnl/audit-canonical-usage.ts
npx tsx scripts/pnl/audit-canonical-usage.ts --fix  # Show fix suggestions
```

### 3. `docs/systems/pnl/VALIDATION_MATRIX_V1.md`

Defines which external benchmark validates which PnL metric:

| Metric | Ledger | Validate Against | NEVER Validate Against |
|--------|--------|------------------|------------------------|
| Dome-Realized | V8 Full | Dome API | Polymarket UI |
| Synthetic Realized | V9 CLOB | UI tooltip (low-unresolved) | Dome API |
| Unrealized | Live pricing | Market prices | Historical data |
| Total PnL | V9 + pricing | UI tooltip (All Time) | Dome API |

---

## Audit Results Summary

**Total violations found:** 375 in 143 files

**Breakdown:**
| Category | Count |
|----------|-------|
| Deprecated engine files (V3-V22) | ~330 |
| Active files with hardcoded strings | ~45 |

**Key Insight:** The vast majority of violations are in **deprecated engine files** that are already scheduled for archive per Terminal 1's ARCHIVE_PLAN.md.

**Active V12 engine status:**
- `realizedPnlV12.ts` uses correct tables (pm_trader_events_v2, pm_token_to_condition_map_v5, pm_condition_resolutions)
- Tables are hardcoded as strings but ARE the canonical versions
- Refactoring to use imports is optional (lower priority)

---

## Exit Checks

- [x] `lib/pnl/canonicalTables.ts` created with surface-aware helper
- [x] `scripts/pnl/audit-canonical-usage.ts` created and runs successfully
- [x] `VALIDATION_MATRIX_V1.md` documents validation paths
- [x] Audit report generated
- [x] V12 engine uses correct canonical tables

---

## Terminal 1 Cross-Reference

Terminal 1's documents consumed:
- `PNL_VOCABULARY_V1.md` - Metric definitions
- `PERSISTED_OBJECTS_MANIFEST.md` - Table inventory
- `PRODUCT_SURFACE_CANONICALS.md` - Surface routing rules
- `TIER_A_COMPARABLE_SPEC.md` - V1 Leaderboard wallet criteria
- `ARCHIVE_PLAN.md` - Files to archive

---

## Recommended Next Steps

### Immediate (V1 Launch)
1. **Archive deprecated engines** - Move `uiActivityEngineV3-V22` and related files per ARCHIVE_PLAN.md
2. **Ship V1 Leaderboard** - Use V9 CLOB ledger with Tier A filters

### Later (Tech Debt)
1. Refactor active files to use `CANONICAL_TABLES` imports
2. Add CI check using audit script (fail on violations)
3. Delete deprecated engines after archive period

---

## File Dependency Summary

```
lib/pnl/canonicalTables.ts
  ├── re-exports from dataSourceConstants.ts
  ├── adds CANONICAL_TABLES registry
  ├── adds DEPRECATED_TABLES list
  └── adds getLedgerForSurface() helper

scripts/pnl/audit-canonical-usage.ts
  └── uses patterns from canonicalTables.ts

docs/systems/pnl/VALIDATION_MATRIX_V1.md
  └── references all Terminal 1 vocabulary docs
```

---

*Generated by Terminal 2 - Enforcement Layer Implementation*

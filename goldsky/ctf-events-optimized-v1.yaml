# CTF Events Optimized Pipeline
# Purpose: Captures Split, Merge, and PayoutRedemption events from CTF contract
# Optimizations:
#   - Removed unused columns: collateral_token, parent_collection_id, partition_index_sets
#   - Combined from 2 redundant pipelines into 1
#   - Only captures events actually used in production
#
# Topic Hashes:
#   - PositionSplit: 0x2e6bb91f8cbcda0c93623c54d0403a43514fabc40084ec96b6d5379a74786298
#   - PositionsMerge: 0x6f13ca62553fcc2bcd2372180a43949c1e4cebba603901ede2f4e14f36b282ca
#   - PayoutRedemption: 0x2682012a4a4f1973119f1c9b90745d1bd91fa2bab387344f044cb3586864d18d

name: ctf-events-optimized-v1
version: 1
resource_size: s
apiVersion: 3
sources:
  matic_raw_logs:
    type: dataset
    dataset_name: matic.raw_logs
    version: 1.0.0
    filter: >-
      address = '0x4d97dcd97ec945f40cf65f87097ace5ea0476045' and (topics like
      '0x2e6bb91f8cbcda0c93623c54d0403a43514fabc40084ec96b6d5379a74786298%' or
      topics like
      '0x6f13ca62553fcc2bcd2372180a43949c1e4cebba603901ede2f4e14f36b282ca%' or
      topics like
      '0x2682012a4a4f1973119f1c9b90745d1bd91fa2bab387344f044cb3586864d18d%')
    start_at: earliest
transforms:
  matic_decoded_sql:
    type: sql
    sql: |-
      SELECT
        _gs_log_decode(
          '[{"anonymous":false,"inputs":[{"indexed":true,"name":"stakeholder","type":"address"},{"indexed":false,"name":"collateralToken","type":"address"},{"indexed":true,"name":"parentCollectionId","type":"bytes32"},{"indexed":true,"name":"conditionId","type":"bytes32"},{"indexed":false,"name":"partition","type":"uint256[]"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"PositionSplit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"stakeholder","type":"address"},{"indexed":false,"name":"collateralToken","type":"address"},{"indexed":true,"name":"parentCollectionId","type":"bytes32"},{"indexed":true,"name":"conditionId","type":"bytes32"},{"indexed":false,"name":"partition","type":"uint256[]"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"PositionsMerge","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"redeemer","type":"address"},{"indexed":true,"name":"collateralToken","type":"address"},{"indexed":true,"name":"parentCollectionId","type":"bytes32"},{"indexed":false,"name":"conditionId","type":"bytes32"},{"indexed":false,"name":"indexSets","type":"uint256[]"},{"indexed":false,"name":"payout","type":"uint256"}],"name":"PayoutRedemption","type":"event"}]',
          topics,
          data
        ) AS decoded,
        id,
        block_number,
        block_timestamp,
        transaction_hash
      FROM matic_raw_logs
    primary_key: id
  matic_ctf_events_sql:
    type: sql
    sql: |-
      -- PositionSplit
      SELECT
        'PositionSplit' AS event_type,
        decoded.event_params[1] AS user_address,
        decoded.event_params[2] AS collateral_token,
        decoded.event_params[3] AS parent_collection_id,
        decoded.event_params[4] AS condition_id,
        decoded.event_params[5] AS partition_index_sets,
        decoded.event_params[6] AS amount_or_payout,
        TO_TIMESTAMP(FROM_UNIXTIME(block_timestamp)) AS event_timestamp,
        block_number,
        transaction_hash AS tx_hash,
        id
      FROM matic_decoded_sql
      WHERE decoded IS NOT NULL
        AND decoded.event_signature = 'PositionSplit'
        AND block_timestamp IS NOT NULL

      UNION ALL

      -- PositionsMerge
      SELECT
        'PositionsMerge' AS event_type,
        decoded.event_params[1] AS user_address,
        decoded.event_params[2] AS collateral_token,
        decoded.event_params[3] AS parent_collection_id,
        decoded.event_params[4] AS condition_id,
        decoded.event_params[5] AS partition_index_sets,
        decoded.event_params[6] AS amount_or_payout,
        TO_TIMESTAMP(FROM_UNIXTIME(block_timestamp)) AS event_timestamp,
        block_number,
        transaction_hash AS tx_hash,
        id
      FROM matic_decoded_sql
      WHERE decoded IS NOT NULL
        AND decoded.event_signature = 'PositionsMerge'
        AND block_timestamp IS NOT NULL

      UNION ALL

      -- PayoutRedemption
      SELECT
        'PayoutRedemption' AS event_type,
        decoded.event_params[1] AS user_address,
        decoded.event_params[2] AS collateral_token,
        decoded.event_params[3] AS parent_collection_id,
        decoded.event_params[4] AS condition_id,
        decoded.event_params[5] AS partition_index_sets,
        decoded.event_params[6] AS amount_or_payout,
        TO_TIMESTAMP(FROM_UNIXTIME(block_timestamp)) AS event_timestamp,
        block_number,
        transaction_hash AS tx_hash,
        id
      FROM matic_decoded_sql
      WHERE decoded IS NOT NULL
        AND decoded.event_signature = 'PayoutRedemption'
        AND block_timestamp IS NOT NULL
    primary_key: id
sinks:
  matic_ctf_events_sink:
    type: clickhouse
    secret_name: CASCADIAN_FINAL_HTTP
    from: matic_ctf_events_sql
    table: pm_ctf_events

=================================================================================
DATABASE DUPLICATION INVESTIGATION - EXECUTIVE SUMMARY
=================================================================================

Wallet: 0x4bfb41d5b3570defd03c39a9a4d8de6bd8b8982e
Table: pm_trades_canonical_v3
Date: 2025-11-18 (PST)
Investigator: Claude 1 (Explore Agent)

=================================================================================
KEY FINDINGS
=================================================================================

âŒ ORIGINAL CLAIM: "16.6M duplicate rows"
âœ… ACTUAL FINDING: "21.8M UNIQUE rows with timestamp anomalies"

ISSUE TYPE: Data Quality (Timestamp Corruption)
SEVERITY: ğŸš¨ CRITICAL
PRODUCTION IMPACT: âš ï¸  HIGH - Do not use this table for production queries

=================================================================================
THE NUMBERS
=================================================================================

Total Rows:              21,795,362
Unique trade_ids:        21,799,517  (more than total rows!)
Unique trade_keys:       21,801,206  (more than total rows!)
Unique tx_hashes:        21,626,018  (slightly less than total)

Transaction duplicates:  10 (only 2x each)
Trade key duplicates:    0 (zero)

Conclusion: NOT A DUPLICATION ISSUE

=================================================================================
TIMESTAMP ANALYSIS
=================================================================================

Year Distribution:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Year â”‚ Row Count   â”‚ Percentage â”‚ Status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2024 â”‚  3,619,705  â”‚    17%     â”‚ âœ… OK  â”‚
â”‚ 2025 â”‚ 18,175,657  â”‚    83%     â”‚ âŒ BAD â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timestamp Range:
  Earliest: 2024-01-06 08:34:30
  Latest:   2025-10-31 10:00:38  (FUTURE!)

Build Timestamp: 2025-11-16 21:40:33  (FUTURE!)

Timestamp Collisions (Impossible):
  2025-10-27 13:13:45 â†’ 9,927 trades (same second!)
  2025-10-10 20:47:02 â†’ 9,280 trades
  2025-10-26 21:40:25 â†’ 8,740 trades

=================================================================================
ROOT CAUSE HYPOTHESIS
=================================================================================

ğŸ” Most Likely: System clock set to 2025-11-16 during ingestion

Evidence:
  â€¢ build_timestamp shows 2025-11-16 21:40:33
  â€¢ created_at shows 2025-11-16 (system time)
  â€¢ 83% of trade timestamps are in 2025
  â€¢ Ingestion window: 21:05:22 to 22:06:42 (1 hour)

ğŸ” Alternative: This is test/synthetic data

Evidence:
  â€¢ All trade_ids contain "-undefined-taker"
  â€¢ Impossible timestamp collisions (9,927/sec)
  â€¢ Perfect round numbers for many trades

=================================================================================
DATA QUALITY ISSUES
=================================================================================

1. Malformed Trade IDs
   âœ— 0x...hash...-undefined-taker (all 21.8M rows)
   âœ“ Should be: 0x...hash...-{wallet}-maker

2. Timestamp Precision Loss
   â€¢ 9,927 trades share identical second
   â€¢ Millisecond precision lost

3. ReplacingMergeTree Not Working
   â€¢ 22 different version timestamps
   â€¢ No duplicate trade_ids being merged
   â€¢ Suggests unique trade_ids or pending merge

=================================================================================
TABLE SCHEMA
=================================================================================

Engine: SharedReplacingMergeTree
ORDER BY: trade_id (String)
Version Column: created_at (DateTime)

Columns: 30 total
  - trade_id (String)
  - trade_key (String)
  - transaction_hash (String)
  - wallet_address (String)
  - timestamp (DateTime) â† CORRUPTED
  - created_at (DateTime) â† FUTURE DATE
  - version (DateTime)
  - source (Enum8: clob/erc1155/canonical)
  - build_version (String) = "v3.0.0"
  - build_timestamp (DateTime) â† FUTURE DATE

=================================================================================
RECOMMENDED ACTIONS
=================================================================================

âš¡ IMMEDIATE (Do Now):
  1. Check system clock on ingestion server
  2. Verify if this is production or test data
  3. Stop using pm_trades_canonical_v3 for production
  4. Check pm_trades_canonical_v2 for comparison

ğŸ”¥ HIGH PRIORITY (24 Hours):
  1. If system clock was wrong: Re-run ingestion
  2. If test data: Delete and ingest real data
  3. Fix trade_id construction (remove "-undefined-")
  4. Add timestamp validation

ğŸ“‹ MEDIUM PRIORITY (1 Week):
  1. Add schema constraints (timestamp < NOW())
  2. Add monitoring for timestamp anomalies
  3. Backfill with corrected pipeline
  4. Update frontend to use verified table

=================================================================================
NATURAL PRIMARY KEY RECOMMENDATION
=================================================================================

Current (broken):
  trade_id = "0x{tx_hash}-undefined-taker"

Recommended:
  trade_id = "0x{tx_hash}-{wallet}-{market_id}-{outcome_index}-{side}"

Or composite key:
  PRIMARY KEY (transaction_hash, wallet_address, timestamp_ms)

=================================================================================
FILES CREATED
=================================================================================

1. DUPLICATION_INVESTIGATION_REPORT.md (detailed analysis)
2. investigate-schema-duplication.ts (investigation script)
3. investigate-wallet-field.ts (wallet analysis script)
4. verify-timestamp-corruption.ts (timestamp verification script)
5. INVESTIGATION_SUMMARY.txt (this file)

=================================================================================
TIME SPENT
=================================================================================

Investigation: 15 minutes
Documentation: 5 minutes
Total: 20 minutes

=================================================================================
CONCLUSION
=================================================================================

This is NOT a duplication issue. The wallet legitimately has 21.8M trades
in the database, but 83% have corrupted timestamps showing future dates (2025).

The most likely cause is that the ingestion server's system clock was set to
2025-11-16 when the v3.0.0 pipeline ran, causing all system-generated timestamps
(build_timestamp, created_at) to be in the future.

The table should not be used for production until timestamps are corrected.

=================================================================================
Agent: Claude 1 (Explore Agent)
Timezone: PST (California)
Date: 2025-11-18
=================================================================================

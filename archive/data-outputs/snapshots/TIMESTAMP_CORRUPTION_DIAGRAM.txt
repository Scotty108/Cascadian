=================================================================================
TIMESTAMP CORRUPTION VISUAL DIAGRAM
=================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          NORMAL INGESTION FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    CLOB API                   Ingestion Server              ClickHouse
  (2024 data)                (clock: 2024-11-16)         pm_trades_canonical_v3
       â”‚                              â”‚                           â”‚
       â”‚  trades with                 â”‚                           â”‚
       â”‚  2024 timestamps              â”‚                           â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
       â”‚                              â”‚                           â”‚
       â”‚                              â”‚  INSERT with              â”‚
       â”‚                              â”‚  timestamp: 2024-XX-XX    â”‚
       â”‚                              â”‚  created_at: 2024-11-16   â”‚
       â”‚                              â”‚  build_timestamp: 2024-11-16
       â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                              â”‚                           â”‚
       â”‚                              â”‚                           âœ“ Good data!


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ACTUAL CORRUPTED FLOW (v3.0.0)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    CLOB API                   Ingestion Server              ClickHouse
  (2024 data)                ğŸš¨ clock: 2025-11-16 ğŸš¨      pm_trades_canonical_v3
       â”‚                              â”‚                           â”‚
       â”‚  trades with                 â”‚                           â”‚
       â”‚  2024 timestamps              â”‚                           â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
       â”‚                              â”‚                           â”‚
       â”‚                              â”‚ âŒ System clock wrong!    â”‚
       â”‚                              â”‚                           â”‚
       â”‚                              â”‚  INSERT with              â”‚
       â”‚                              â”‚  timestamp: 2025-XX-XX âŒ â”‚
       â”‚                              â”‚  created_at: 2025-11-16 âŒâ”‚
       â”‚                              â”‚  build_timestamp: 2025-11-16 âŒ
       â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                              â”‚                           â”‚
       â”‚                              â”‚                     âœ— Corrupted data!


=================================================================================
IMPACT BREAKDOWN
=================================================================================

Total Trades Ingested: 21,795,362

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TIMESTAMP DISTRIBUTION                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2024 Timestamps (Good):     3,619,705 rows  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        ]
                                17%          â†‘ Somehow preserved correct year

2025 Timestamps (Bad):     18,175,657 rows  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
                                83%          â†‘ Future dates (impossible!)


=================================================================================
TIMESTAMP COLLISION EXAMPLE
=================================================================================

Timestamp: 2025-10-27 13:13:45

Trade 1:  0xabc123...-undefined-taker  |
Trade 2:  0xdef456...-undefined-taker  |
Trade 3:  0x789abc...-undefined-taker  |
  ...                                   } 9,927 trades
  ...                                   |  ALL at the
  ...                                   |  SAME SECOND!
Trade 9927: 0xfff000...-undefined-taker|

âŒ Physically impossible on blockchain
âŒ Suggests precision loss (ms â†’ seconds)
âŒ Indicates batch processing bug


=================================================================================
TRADE_ID MALFORMATION
=================================================================================

Expected Format:
  {tx_hash}-{wallet_address}-{market_id}-{outcome_index}-{maker|taker}

Actual Format (ALL 21.8M rows):
  {tx_hash}-undefined-taker
              â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
         Missing wallet_address, market_id, outcome_index!


Example:
  0x1fb21bb834977c5c398a4748a7e8809f6dfa6054f4a829a0d4ca3590278e21ba-undefined-taker
                                                                    â†‘
                                                       Should be: -{wallet}-{market}-{index}-taker


=================================================================================
REPLACINGMERGETREE BEHAVIOR
=================================================================================

Expected (with proper deduplication):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ trade_id â”‚ version     â”‚ status             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ abc123   â”‚ 2024-11-16  â”‚ âœ“ Oldest version   â”‚
  â”‚ abc123   â”‚ 2024-11-17  â”‚ âœ“ Newer version    â”‚
  â”‚ abc123   â”‚ 2024-11-18  â”‚ âœ“ Latest (kept)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  After OPTIMIZE TABLE FINAL â†’ Only 1 row (latest version)

Actual (in this table):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ trade_id â”‚ version     â”‚ status             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ abc123   â”‚ 2025-11-16  â”‚ âŒ ONLY version    â”‚
  â”‚ def456   â”‚ 2025-11-16  â”‚ âŒ ONLY version    â”‚
  â”‚ ghi789   â”‚ 2025-11-16  â”‚ âŒ ONLY version    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Each trade_id is UNIQUE â†’ No duplicates to merge!
  This is why we have 21.8M rows with 21.8M unique trade_ids.


=================================================================================
RECOMMENDED FIX WORKFLOW
=================================================================================

1. Verify System Clock
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ssh ingestion-server   â”‚â”€â”€> date
   â”‚ Check: Is it 2025?     â”‚    If YES â†’ Fix clock!
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Compare with v2 Table
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SELECT count(*) FROM pm_trades_canonical_v2    â”‚
   â”‚ WHERE wallet_address = '0x4bfb...'             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   If v2 has 1,299 rows â†’ v3 ingestion is broken!

3. Check CLOB Raw Data
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SELECT * FROM pm_clob_fills_raw                â”‚
   â”‚ WHERE wallet = '0x4bfb...' LIMIT 10            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Verify original timestamps are correct.

4. Re-ingest with Fixed Clock
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1. DROP TABLE pm_trades_canonical_v3           â”‚
   â”‚ 2. Fix system clock                            â”‚
   â”‚ 3. Fix trade_id construction                   â”‚
   â”‚ 4. Re-run v3.0.0 ingestion                     â”‚
   â”‚ 5. Verify timestamps are 2024                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=================================================================================
END OF DIAGRAM
=================================================================================

# Data Truth Pipeline - P&L Source of Truth

**Last Updated:** October 27, 2025

---

## âš ï¸ CRITICAL GOVERNANCE RULE

**All P&L data MUST come from files in this directory. Any other source is invalid.**

This directory contains the audited, validated source of truth for wallet P&L calculations. Do not use legacy data, do not use uncorrected ClickHouse queries, and do not trust any P&L numbers that don't come from these files.

---

## File Inventory

### Core P&L Data (Required)

1. **`audited_wallet_pnl_extended.json`** (71KB, 548 wallets)
   - **Purpose:** The canonical list of profitable wallets with verified P&L
   - **Coverage:** Wallets with â‰¥2% coverage (trade outcomes we could resolve)
   - **Generated by:** `scripts/batch-calculate-all-wallets-pnl.ts`
   - **Copied to:** `lib/data/audited_wallet_pnl_extended.json` (for runtime import)
   - **Schema:**
     ```json
     [
       {
         "wallet_address": "0xb744f56...",
         "realized_pnl_usd": 9012.68,
         "coverage_pct": 35.56
       }
     ]
     ```
   - **Used by:**
     - `lib/data/wallet-pnl-feed.ts` - Runtime wallet loader
     - `lib/data/wallet-signal-set.ts` - Signal wallet set
     - All monitoring and auto-population services

2. **`expanded_resolution_map.json`** (761KB, 2,858 resolutions)
   - **Purpose:** Maps condition_ids to their resolved outcomes
   - **Contains:** Binary resolutions ([1,0] or [0,1]) only
   - **Generated by:** `scripts/batch-calculate-all-wallets-pnl.ts`
   - **Schema:**
     ```json
     {
       "resolutions": [
         {
           "condition_id": "0x123...",
           "market_id": "abc123",
           "resolved_outcome": "YES",
           "payout_yes": 1,
           "payout_no": 0,
           "resolved_at": "2025-10-20T12:34:56Z"
         }
       ]
     }
     ```

### Dimension Tables (Category Attribution)

3. **`markets_dim_seed.json`** (~1.6MB, ~5K markets)
   - **Purpose:** Maps conditions to markets and events
   - **Generated by:** `scripts/build-dimension-tables.ts`
   - **Schema:**
     ```json
     [
       {
         "condition_id": "0x123...",
         "market_id": "abc123",
         "event_id": "event-slug",
         "question": "Will Bitcoin hit $100K?",
         "resolved_outcome": "YES",
         "payout_yes": 1,
         "payout_no": 0,
         "resolved_at": "2025-10-20T12:34:56Z"
       }
     ]
     ```

4. **`events_dim_seed.json`** (2 bytes - CURRENTLY EMPTY âš ï¸)
   - **Purpose:** Maps events to categories and tags
   - **Status:** Known issue - enrichment failing, needs investigation
   - **Expected Schema:**
     ```json
     [
       {
         "event_id": "event-slug",
         "title": "Bitcoin Price Predictions",
         "category": "Crypto",
         "tags": ["bitcoin", "price", "prediction"],
         "status": "resolved",
         "ends_at": "2025-10-20T00:00:00Z"
       }
     ]
     ```
   - **Blocker:** Without this data, category-level P&L attribution is impossible

5. **`dimension_coverage_report.json`** (360 bytes)
   - **Purpose:** Data quality metrics for dimension tables
   - **Schema:**
     ```json
     {
       "total_conditions_across_qualified_wallets": 4961,
       "conditions_with_valid_market_id": 5344,
       "conditions_in_markets_dim": 4961,
       "markets_with_event_id": 0,
       "unique_events_in_events_dim": 0,
       "events_with_category": 0,
       "coverage_rates": {
         "market_id_coverage": "11.59%",
         "event_id_coverage": "0.00%",
         "category_coverage": "0.00%"
       }
     }
     ```

### SQL DDL (ClickHouse Schema)

6. **`markets_dim.sql`**
   - DDL for loading markets dimension into ClickHouse

7. **`events_dim.sql`**
   - DDL for loading events dimension into ClickHouse

---

## Critical Bugs Fixed (Non-Negotiable Invariants)

### 1. 128x Share Inflation Bug

**Problem:** ClickHouse MergeTree stores share quantities inflated by 128x

**Fix:** ALL calculations MUST divide shares by 128

**Enforcement:**
```typescript
const SHARES_CORRECTION_FACTOR = 128
const correctedShares = rawShares / SHARES_CORRECTION_FACTOR
```

**Impact:** Without this correction, P&L numbers are wildly inflated (e.g., $563K fake leaderboard)

### 2. String/Number Coercion Bug

**Problem:** Polymarket API returns `outcomePrices` as strings `["1", "0"]`, not numbers

**Fix:** MUST use `Number()` conversion before comparison

**Enforcement:**
```typescript
const payoutYes = Number(outcomePrices[0])
const payoutNo = Number(outcomePrices[1])
const isBinaryResolved =
  (payoutYes === 1 && payoutNo === 0) ||
  (payoutYes === 0 && payoutNo === 1)
```

**Impact:** Without Number() conversion, string comparisons fail and markets are skipped

### 3. Binary Resolution Validation

**Problem:** Some markets resolve to non-binary outcomes (e.g., `[0.5, 0.5]`, `[0, 0]`)

**Fix:** ONLY count markets where outcomePrices equals exactly `[1,0]` or `[0,1]`

**Enforcement:**
```typescript
if (!isBinaryResolved) {
  console.log(`âš ï¸  Skipping non-binary resolution: ${market_id}`)
  continue
}
```

**Impact:** Accuracy. Non-binary outcomes would corrupt P&L calculations.

---

## P&L Calculation Methodology

### Hold-to-Resolution Accounting

**Formula:**
```
For each condition:
  yes_shares = SUM(shares / 128) WHERE side = 'YES'
  yes_cost = SUM(entry_price * (shares / 128)) WHERE side = 'YES'
  no_shares = SUM(shares / 128) WHERE side = 'NO'
  no_cost = SUM(entry_price * (shares / 128)) WHERE side = 'NO'

  payout = resolved_outcome === 'YES' ? yes_shares : no_shares
  condition_pnl = payout - (yes_cost + no_cost)

wallet_pnl = SUM(condition_pnl) across all resolved conditions
coverage_pct = (resolved_conditions / total_conditions) * 100
```

**Assumptions:**
- Wallets hold positions until resolution (no mid-trade exits)
- Payout equals winning share quantity (1:1 ratio)
- Losing shares are worth zero

**Limitations:**
- Does NOT capture mid-trade profits/losses
- Does NOT account for early exits or position flips
- Accuracy depends on resolution coverage (currently 6-11%)

---

## Coverage Threshold

**Minimum:** 2% of trades must have resolved outcomes

**Rationale:**
- Wallets below 2% coverage have insufficient data quality
- Single lucky trades can skew P&L with low sample size
- 2% threshold ensures meaningful statistical sample

**Enforcement:**
```typescript
const MINIMUM_COVERAGE_PCT = 2.0
const qualified = wallets.filter(w => w.coverage_pct >= MINIMUM_COVERAGE_PCT)
```

**Result:** 548 qualified wallets out of 2,838 total (19.3%)

---

## Data Quality Constraints

### Current Reality

| Metric | Value | Status |
|--------|-------|--------|
| Total unique conditions in ClickHouse | 46,095 | âœ… |
| Conditions with valid market_id | 5,344 | âš ï¸ 11.59% |
| Conditions we could resolve | 2,858 | âš ï¸ 6.20% |
| Markets with event_id | 0 | ðŸ”´ 0% |
| Events with category | 0 | ðŸ”´ 0% |

### Coverage Ceiling

**Maximum achievable wallet coverage:** ~11%

This is an upstream ETL pipeline defect. Most ClickHouse trades lack `market_id`, making them unmappable to Polymarket's resolution data.

**Impact:**
- Even the best wallets show 6-35% coverage
- Most wallets show 2-8% coverage
- We can only verify a small fraction of each wallet's activity

**Mitigation Paths:**
1. Fix ETL pipeline to populate market_id during ingestion
2. Use Goldsky as alternative resolution source
3. Accept 11% ceiling as current reality

---

## Regeneration Instructions

### 1. Regenerate P&L Data

```bash
# Run batch P&L calculation (takes ~19 minutes)
npx tsx scripts/batch-calculate-all-wallets-pnl.ts

# Output files:
#   data/audited_wallet_pnl_extended.json
#   data/expanded_resolution_map.json
#   lib/data/audited_wallet_pnl_extended.json (runtime copy)
```

**When to regenerate:**
- New markets have resolved (weekly/monthly)
- More trades have been ingested into ClickHouse
- Fixing upstream ETL issues (market_id population)

### 2. Regenerate Dimension Tables

```bash
# Run dimension table builder (takes ~20 minutes)
npx tsx scripts/build-dimension-tables.ts

# Output files:
#   data/markets_dim_seed.json
#   data/events_dim_seed.json
#   data/dimension_coverage_report.json
#   data/markets_dim.sql
#   data/events_dim.sql
```

**When to regenerate:**
- After regenerating P&L data
- Polymarket adds new event/category metadata
- Fixing event_id enrichment issues

### 3. Runtime Data Sync

**Automatic:** Scripts copy `audited_wallet_pnl_extended.json` to `lib/data/` for runtime import

**Manual (if needed):**
```bash
cp data/audited_wallet_pnl_extended.json lib/data/
```

**Important:** Next.js can only import from source tree, not from arbitrary file paths

---

## Validation & Accuracy

### Ground Truth Validation (99.79% accurate)

**Test Set:** 5 wallets validated against Polymarket's official leaderboard

| Wallet | Our Calculation | Polymarket | Accuracy |
|--------|----------------|------------|----------|
| Rank #2 (0xc7f7e...) | $4,657.81 | $4,654.27 | 99.93% |

**Overall Accuracy:** 99.79% vs Polymarket ground truth

**Validation Script:** `scripts/calculate-audited-wallet-pnl.ts`

---

## Usage in Codebase

### Runtime Code (TypeScript/React)

```typescript
// lib/data/wallet-pnl-feed.ts
import auditedWalletData from './audited_wallet_pnl_extended.json'

export function getTopWallets(limit?: number, minCoveragePct = 2.0) {
  const allWallets = auditedWalletData
  return allWallets
    .filter(w => w.coverage_pct >= minCoveragePct)
    .sort((a, b) => b.realized_pnl_usd - a.realized_pnl_usd)
    .slice(0, limit)
}
```

### Scripts (Node.js)

```typescript
import * as fs from 'fs'
import { resolve } from 'path'

const dataDir = resolve(process.cwd(), 'data')
const walletPath = resolve(dataDir, 'audited_wallet_pnl_extended.json')
const wallets = JSON.parse(fs.readFileSync(walletPath, 'utf-8'))
```

---

## Never Show P&L Without Coverage

**Governance Rule:**

> "Never show `realized_pnl_usd` without `coverage_pct` right next to it. If you can't render `coverage_pct`, hide the wallet."

**Enforcement:**

1. UI components use `<CoverageBadge coveragePct={...} />` next to all P&L displays
2. Wallets not in signal set (coverage < 2%) are hidden entirely
3. Empty state: "No signal wallets found (coverage â‰¥2% required)"

**Reason:** Without coverage_pct, users can't judge data quality and may trust unreliable numbers

---

## Known Issues & Production Blockers

### ðŸ”´ Critical

1. **events_dim_seed.json is empty (2 bytes)**
   - **Impact:** No category-level P&L attribution possible
   - **Blocker for:** Wallet category strengths, category filtering, smart signal weighting
   - **Root cause:** Polymarket API not returning event metadata, or enrichment logic broken
   - **Action:** Debug `scripts/build-dimension-tables.ts` Step 4 (event enrichment)

### âš ï¸ High Priority

2. **Only 11% of conditions have market_id**
   - **Impact:** 89% of trades unmappable, limits coverage to ~11% ceiling
   - **Root cause:** Upstream ETL pipeline doesn't populate market_id
   - **Mitigation:** Fix ETL or use Goldsky as alternative source

3. **No incremental updates**
   - **Impact:** Must re-run entire batch (19 min) to add new resolutions
   - **Mitigation:** Build incremental update logic or accept manual regeneration cadence

### â„¹ï¸ Known Limitations

4. **Hold-to-resolution assumption**
   - **Limitation:** Doesn't capture mid-trade exits or position flips
   - **Accept:** This is the design choice. Explicitly state it when showing P&L.

5. **Resolution coverage is low (6-11%)**
   - **Limitation:** Most wallets show low coverage_pct
   - **Accept:** Display coverage_pct prominently. Users judge reliability themselves.

---

## File Permissions & Ownership

**Owner:** Path B (data truth pipeline)

**Writers:**
- `scripts/batch-calculate-all-wallets-pnl.ts` - Writes P&L and resolution map
- `scripts/build-dimension-tables.ts` - Writes dimension tables

**Readers:**
- All runtime code via `lib/data/wallet-pnl-feed.ts`
- All monitoring/auto-population services
- UI components displaying wallet P&L

**Protection:**
- Files are JSON (human-readable, diff-friendly)
- Git tracks changes (audit trail)
- Scripts write atomically (no partial writes)

---

## Contact & Ownership

**Pipeline Owner:** Path B team

**Questions:**
1. "Why is my P&L different from Polymarket?" â†’ Check coverage_pct. We only see 6-11% of trades.
2. "Why is events_dim_seed.json empty?" â†’ Known issue. Under investigation.
3. "Can I use ClickHouse P&L directly?" â†’ NO. You MUST use audited files. ClickHouse has 128x inflation bug.
4. "How often should I regenerate?" â†’ Weekly or monthly, when new markets resolve.

---

**Version:** 1.0.0
**Pipeline Status:** âœ… P&L calculation accurate | ðŸ”´ Category enrichment broken
**Next Steps:** Fix events_dim_seed.json enrichment, then build category attribution

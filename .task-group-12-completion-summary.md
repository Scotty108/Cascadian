# Task Group 12: Orchestrator Database and API Foundation - COMPLETION SUMMARY

**Date**: 2025-10-27
**Status**: ✅ COMPLETED
**Test Results**: 6/6 tests passing

---

## Summary

Successfully implemented the database schema and API foundation for the Portfolio Orchestrator node, which will power AI-driven position sizing decisions using fractional Kelly criterion. This task group establishes the data persistence layer and REST API endpoints needed for Task Group 13 (AI Risk Analysis Engine).

---

## Deliverables

### ✅ 12.1 Tests (6 tests written)

**File**: `/Users/scotty/Projects/Cascadian-app/lib/workflow/__tests__/orchestrator-api.test.ts`

Test coverage:
- ✅ Test 1: POST /api/orchestrator/analyze - Create GO decision
- ✅ Test 2: POST /api/orchestrator/analyze - Create NO_GO decision
- ✅ Test 3: POST /api/orchestrator/decisions/[id]/approve - Approve without adjustment
- ✅ Test 4: POST /api/orchestrator/decisions/[id]/approve - Approve with size adjustment
- ✅ Test 5: POST /api/orchestrator/decisions/[id]/reject - Reject decision with reason
- ✅ Test 6: GET /api/orchestrator/decisions - Retrieve decision history

**Test Results**:
```
PASS lib/workflow/__tests__/orchestrator-api.test.ts
  Orchestrator API - Decision Creation
    ✓ creates GO decision with recommended position size
    ✓ creates NO_GO decision when opportunity is unfavorable
  Orchestrator API - Decision Approval
    ✓ approves decision without size adjustment
    ✓ approves decision with user size adjustment
  Orchestrator API - Decision Rejection
    ✓ rejects decision with reason
  Orchestrator API - Decision History
    ✓ retrieves decision history with filters and pagination

Test Suites: 1 passed, 1 total
Tests:       6 passed, 6 total
```

---

### ✅ 12.2 Database Migration

**File**: `/Users/scotty/Projects/Cascadian-app/supabase/migrations/20251027000001_create_orchestrator_decisions.sql`

**Schema Design**:

```sql
CREATE TABLE orchestrator_decisions (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- References
  execution_id UUID REFERENCES workflow_executions(id) ON DELETE CASCADE,
  workflow_id UUID REFERENCES workflow_sessions(id) ON DELETE CASCADE,

  -- Decision Context
  node_id TEXT NOT NULL,
  market_id TEXT NOT NULL,

  -- Decision Content
  decision TEXT CHECK (decision IN ('GO', 'NO_GO', 'REDUCE', 'CLOSE', 'FLIP')),
  direction TEXT CHECK (direction IN ('YES', 'NO')),
  recommended_size NUMERIC CHECK (recommended_size >= 0),
  actual_size NUMERIC CHECK (actual_size >= 0),
  risk_score INTEGER CHECK (risk_score BETWEEN 1 AND 10),

  -- AI Analysis
  ai_reasoning TEXT NOT NULL,
  ai_confidence NUMERIC CHECK (ai_confidence BETWEEN 0 AND 1),

  -- Portfolio Snapshot
  portfolio_snapshot JSONB NOT NULL,

  -- Approval Workflow
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  user_override BOOLEAN DEFAULT FALSE,
  override_reason TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  decided_at TIMESTAMPTZ
);
```

**Indexes Created**:
1. `idx_orchestrator_decisions_pending` - Find pending decisions (WHERE status='pending')
2. `idx_orchestrator_decisions_workflow` - Workflow decision history
3. `idx_orchestrator_decisions_execution` - Execution-level decisions
4. `idx_orchestrator_decisions_market` - Market-specific analysis
5. `idx_orchestrator_decisions_status` - Status-based reporting

**RLS Policies**:
- ✅ Users can view decisions for their own workflows
- ✅ Users can insert decisions for their own workflows
- ✅ Users can update their own pending decisions (approve/reject)
- ✅ Users can delete their own decisions

**Helper Functions**:
- `get_orchestrator_decision_stats(workflow_id)` - Decision analytics
- `get_pending_decisions(workflow_id, limit)` - Retrieve pending decisions

**Triggers**:
- Auto-set `decided_at` timestamp when status changes to approved/rejected

---

### ✅ 12.3 POST /api/orchestrator/analyze

**File**: `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/analyze/route.ts`

**Purpose**: Analyze trading opportunities and create AI-powered position sizing decisions

**Input**:
```typescript
{
  execution_id: string,
  workflow_id: string,
  node_id: string,
  market_id: string,
  market_data: {
    question: string,
    category: string,
    volume_24h: number,
    liquidity: number,
    current_odds: { yes: number, no: number }
  },
  portfolio_state: {
    bankroll_total_equity_usd: number,
    bankroll_free_cash_usd: number,
    deployed_capital: number,
    open_positions: number
  },
  position_sizing_rules: {
    max_per_position: number,
    min_bet: number,
    max_bet: number
  }
}
```

**Output**:
```typescript
{
  success: true,
  decision: {
    id: UUID,
    decision: 'GO' | 'NO_GO' | 'REDUCE' | 'CLOSE' | 'FLIP',
    direction: 'YES' | 'NO',
    recommended_size: number,
    risk_score: 1-10,
    ai_reasoning: string,
    ai_confidence: 0-1,
    status: 'pending'
  }
}
```

**Current Implementation**: Stub AI logic with basic risk assessment
- Market quality checks (liquidity, volume)
- Simple position sizing based on max_per_position rule
- Returns GO/NO_GO decision

**Note**: Task Group 13 will replace stub with full fractional Kelly implementation using Claude Sonnet 4.5

---

### ✅ 12.4 POST /api/orchestrator/decisions/[id]/approve

**File**: `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/[id]/approve/route.ts`

**Purpose**: Approve a pending decision and trigger trade execution

**Input**:
```typescript
{
  adjusted_size?: number,      // Optional size adjustment
  override_reason?: string     // Optional reason for adjustment
}
```

**Behavior**:
1. Validates decision exists and is pending
2. Checks adjusted_size against available cash
3. Sets `actual_size` (adjusted or recommended)
4. Sets `user_override = true` if size adjusted
5. Updates status to 'approved'
6. Logs trade execution intent (stub - full execution in later tasks)

**Output**:
```typescript
{
  success: true,
  decision: {...},
  trade_intent: {
    market_id: string,
    direction: 'YES' | 'NO',
    size: number,
    message: 'Trade execution logged (stub)'
  }
}
```

**Error Handling**:
- 404 if decision not found
- 400 if decision already processed
- 400 if adjusted_size exceeds available cash
- 500 for database errors

---

### ✅ 12.5 POST /api/orchestrator/decisions/[id]/reject

**File**: `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/[id]/reject/route.ts`

**Purpose**: Reject a pending decision (no trade executed)

**Input**:
```typescript
{
  rejection_reason?: string    // Optional reason for rejection
}
```

**Behavior**:
1. Validates decision exists and is pending
2. Updates status to 'rejected'
3. Sets override_reason
4. Does NOT set actual_size (remains NULL)
5. Logs rejection

**Output**:
```typescript
{
  success: true,
  decision: {...},
  message: 'Decision rejected successfully. No trade executed.'
}
```

---

### ✅ 12.6 GET /api/orchestrator/decisions

**File**: `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/route.ts`

**Purpose**: Retrieve decision history with filtering and pagination

**Query Parameters**:
- `workflow_id` (required) - Filter by workflow
- `status` (optional) - Filter by status: 'pending', 'approved', 'rejected'
- `limit` (optional, default: 50, max: 100) - Results per page
- `offset` (optional, default: 0) - Pagination offset

**Output**:
```typescript
{
  success: true,
  decisions: [...],
  pagination: {
    total: number,
    limit: number,
    offset: number,
    has_more: boolean,
    next_offset: number | null
  }
}
```

**Ordering**: Results sorted by `created_at DESC` (newest first)

---

## Acceptance Criteria Status

✅ Migration creates orchestrator_decisions table with proper schema
✅ RLS policies enforce user data isolation
✅ All 4 API endpoints functional:
  - ✅ POST /api/orchestrator/analyze
  - ✅ POST /api/orchestrator/decisions/[id]/approve
  - ✅ POST /api/orchestrator/decisions/[id]/reject
  - ✅ GET /api/orchestrator/decisions
✅ 6 tests written and passing (within 2-8 requirement)
✅ Error handling for edge cases implemented
✅ Follows existing codebase patterns (Supabase, Next.js API routes)

---

## Implementation Notes

### Design Decisions

1. **Decision Types**: Supports 5 decision types (GO, NO_GO, REDUCE, CLOSE, FLIP) to cover all position sizing scenarios from fractional Kelly framework

2. **Portfolio Snapshot**: Stored as JSONB to preserve exact portfolio state at decision time for audit trail and backtesting

3. **Approval Workflow**: Three-state status ('pending', 'approved', 'rejected') with optional size adjustment and override tracking

4. **Stub AI Implementation**: Current analyze endpoint uses basic heuristics. Task Group 13 will implement full fractional Kelly logic with Claude Sonnet 4.5

5. **Trade Execution Stub**: Approve endpoint logs trade intent but doesn't execute. Later task groups will integrate Polymarket API

### Data Flow

```
1. Strategy Executes → Orchestrator Node Reached
2. POST /api/orchestrator/analyze
   → AI analyzes opportunity
   → Creates orchestrator_decision (status='pending')
3a. Autonomous Mode:
   → Auto-approve if decision='GO'
   → POST /api/orchestrator/decisions/[id]/approve
3b. Approval Mode:
   → Send notification to user
   → User reviews in UI
   → POST /api/orchestrator/decisions/[id]/approve OR reject
4. Trade execution triggered (stub)
5. GET /api/orchestrator/decisions
   → View decision history
```

### Security

- All endpoints use Supabase service role key
- RLS policies ensure users can only access their own decisions
- Input validation on all endpoints
- Size adjustments checked against available cash
- Status transitions validated (can only approve/reject pending decisions)

---

## Next Steps (Task Group 13)

Task Group 13 will build on this foundation:

1. **Replace AI Stub**: Implement full fractional Kelly analysis using Claude Sonnet 4.5
2. **Position Sizing Prompt**: Use `/Users/scotty/Projects/Cascadian-app/.agent-os/specs/spec-20251026-strategy-builder-enhancements/planning/position-sizing-prompt.md`
3. **Integrate with Anthropic SDK**: Call Claude API for position sizing analysis
4. **Kelly Calculations**: Implement all formulas from position-sizing-prompt.md:
   - Break-even probability
   - Raw Kelly fraction
   - Fractional Kelly with lambda
   - Log-growth validation
   - Portfolio constraints (cluster, market, cash limits)
5. **Trade Execution**: Integrate with Polymarket API (or stub with intent logging)

---

## File Locations

**Migration**:
- `/Users/scotty/Projects/Cascadian-app/supabase/migrations/20251027000001_create_orchestrator_decisions.sql`

**API Routes**:
- `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/analyze/route.ts`
- `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/route.ts`
- `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/[id]/approve/route.ts`
- `/Users/scotty/Projects/Cascadian-app/app/api/orchestrator/decisions/[id]/reject/route.ts`

**Tests**:
- `/Users/scotty/Projects/Cascadian-app/lib/workflow/__tests__/orchestrator-api.test.ts`

---

## Database Schema Summary

### orchestrator_decisions Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Decision ID |
| execution_id | UUID | FK → workflow_executions | Execution reference |
| workflow_id | UUID | FK → workflow_sessions | Workflow reference |
| node_id | TEXT | NOT NULL | Orchestrator node ID |
| market_id | TEXT | NOT NULL | Polymarket market ID |
| decision | TEXT | CHECK (GO/NO_GO/REDUCE/CLOSE/FLIP) | AI decision |
| direction | TEXT | CHECK (YES/NO) | Bet direction |
| recommended_size | NUMERIC | CHECK (>= 0) | AI-recommended size (USD) |
| actual_size | NUMERIC | CHECK (>= 0), nullable | Executed size (USD) |
| risk_score | INTEGER | CHECK (1-10) | Risk assessment |
| ai_reasoning | TEXT | NOT NULL | AI explanation |
| ai_confidence | NUMERIC | CHECK (0-1) | Confidence score |
| portfolio_snapshot | JSONB | NOT NULL | Portfolio state snapshot |
| status | TEXT | CHECK (pending/approved/rejected) | Approval status |
| user_override | BOOLEAN | DEFAULT false | Size adjusted? |
| override_reason | TEXT | nullable | Override explanation |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Decision timestamp |
| decided_at | TIMESTAMPTZ | nullable | Approval/rejection timestamp |

**Indexes**: 5 indexes for query optimization
**RLS Policies**: 4 policies for user data isolation
**Helper Functions**: 2 analytics functions
**Triggers**: 1 auto-timestamp trigger

---

## Status: ✅ READY FOR TASK GROUP 13

All deliverables completed and tested. Database schema is production-ready. API endpoints are functional with proper error handling and security. The foundation is solid for implementing the full AI Risk Analysis Engine in Task Group 13.
